
```{r setup, include=FALSE}
source(here::here("script/setup.R"))
```

```{r}
setwd(here::here("data/"))
GermanCredit <- read_csv("GermanCreditClean.csv")
```

## Exploratory Data Analysis

```{r}
# GermanCredit accepted
YES_GC <- filter(GermanCredit,RESPONSE=="1")
```

```{r}
# GermanCredit refused
NO_GC <- filter(GermanCredit,RESPONSE=="0")
```

The dataset is related to the German Credit. Each applicant is described by 30 variables and the credit application is graded by good or bad.

Let's have a look at the distribution of the applications graded as good and bad

```{r, message=FALSE}
# Distribution of the grade per credit applications
GermanCredit %>% 
  ggplot(aes(x = as.factor(RESPONSE), fill=as.factor(RESPONSE))) +
  geom_bar() +
  labs(title = "Number of credit applications per grade",
       y = "Number",
       x = "Grade") +
  theme(legend.position="none") +
  scale_x_discrete(label=c("0"="No", "1"="Yes")) +
  scale_fill_manual(values = alpha(c("red3", "springgreen4"), .5))
```

```{r}
# Distribution of the continuous variables, i.e. duration, amount, age
# Here duration

p.duration <- GermanCredit %>% 
  ggplot(aes(x = DURATION, y = as.factor(RESPONSE), fill = as.factor(RESPONSE))) +
  geom_boxplot() +
  labs(title = "Duration of the credit applications per grade",
       x = "Months",
       y = "Grade") +
  scale_y_discrete(label=c("0"="No", "1"="Yes")) +
  theme(legend.position="none") +
  scale_fill_manual(values = alpha(c("red3", "springgreen4"), .5))

p.duration

# Nothing to note
```


```{r}
# Same as above, for amount
p.amount <- GermanCredit %>% 
  ggplot(aes(x = AMOUNT, y = as.factor(RESPONSE), fill=as.factor(RESPONSE))) +
  geom_boxplot() +
  labs(title = "Amount of the credit applications per grade",
       x = "DM",
       y = "Grade") +
  scale_y_discrete(label=c("0"="No", "1"="Yes")) +
  theme(legend.position="none") +
  scale_fill_manual(values = alpha(c("red3", "springgreen4"), .5))

p.amount

# A lot of outliers for the good applications
```

```{r}
# Same as above, for age

p.age <- GermanCredit %>% 
  ggplot(aes(x = AGE, y = as.factor(RESPONSE), fill=as.factor(RESPONSE))) +
  geom_boxplot() +
  labs(title = "Age of the credit applicants",
       x = "Years",
       y = "Grade") +
  scale_y_discrete(label=c("0"="No", "1"="Yes")) +
  theme(legend.position="none") +
  scale_fill_manual(values = alpha(c("red3", "springgreen4"), .5))

p.age

# One outlier to recode - 75 years old instead of 125 years old
```

```{r}
# Let's explore the distribution of the categorical variables
#CHK_ACCT
p.chkacct <- GermanCredit %>% 
  ggplot(aes(x = CHK_ACCT, fill=as.factor(RESPONSE)))+
  geom_bar(position = "dodge") +
  labs(title = "Status of the checking account per grade",
       x = "Category",
       y = "Number") +
  theme(legend.position="none") +
  scale_fill_manual(values = alpha(c("red3", "springgreen4"), .5))
  
p.chkacct

# I didn't achieve to put the labels here for the x-axis
```

What does the first category means? <0, meaning 0? So the account is opened but there is nothing on it?
Another point, if you don't have any checking account, your credit applications has more probability to be rated as good?

```{r}
#HISTORY
p.history <- GermanCredit %>% 
  ggplot(aes(x = HISTORY, fill=as.factor(RESPONSE)))+
  geom_bar(position = "dodge") +
  labs(title = "Credit grades related to the history of past credits",
       x = "Category",
       y = "Number") +
  theme(legend.position="none") +
  scale_fill_manual(values = alpha(c("red3", "springgreen4"), .5))
  
p.history
```
Here again, seems weird. At 3 and 4, it means the previous credit were not or partially reimbursed. But they are graded as good?

```{r}
# SAV_ACCT
p.savacct <- GermanCredit %>% 
  ggplot(aes(x = SAV_ACCT, fill=as.factor(RESPONSE)))+
  geom_bar(position = "dodge") +
  labs(title = "Credit grades in regard with the average balance in saving accounts",
       x = "Category",
       y = "Number") +
  theme(legend.position="none") +
  scale_fill_manual(values = alpha(c("red3", "springgreen4"), .5))
  
p.savacct
```
Some questions need to be asked. What's the difference between an application with a small saving accounts and one with none saving accounts? Why the bank gives good grades to the latest?

```{r}
# EMPLOYMENT
p.empl <- GermanCredit %>% 
  ggplot(aes(x = EMPLOYMENT, fill=as.factor(RESPONSE)))+
  geom_bar(position = "dodge") +
  labs(title = "Credit grade with regard to employment duration",
       x = "Category",
       y = "Number") +
  theme(legend.position="none") +
  scale_fill_manual(values = alpha(c("red3", "springgreen4"), .5))
  
p.empl
```

```{r}
# PRESENT_RESIDENTS
p.preres <- GermanCredit %>% 
  ggplot(aes(x = PRESENT_RESIDENT, fill=as.factor(RESPONSE)))+
  geom_bar(position = "dodge") +
  labs(title = "Credit grade related to residents duration stays",
       x = "Category",
       y = "Number") +
  theme(legend.position="none") +
  scale_fill_manual(values = alpha(c("red3", "springgreen4"), .5))
  
p.preres
```

Problem here, the categories should be between 0 and 3 but are between 1 and 4.

```{r}
#JOB
p.job <- GermanCredit %>% 
  ggplot(aes(x = JOB, fill=as.factor(RESPONSE)))+
  geom_bar(position = "dodge") +
  labs(title = "Credit grade related to the nature of jobs",
       x = "Category",
       y = "Number") +
  theme(legend.position="none") +
  scale_fill_manual(values = alpha(c("red3", "springgreen4"), .5))
  
p.job
```

```{r}
# 
p.insrat <- GermanCredit %>% 
  ggplot(aes(x = INSTALL_RATE, fill=as.factor(RESPONSE)))+
  geom_bar(position = "dodge") +
  labs(title = "Credit grade per installment rate",
       x = "% of disposable income",
       y = "Number") +
  theme(legend.position="none") +
  scale_fill_manual(values = alpha(c("red3", "springgreen4"), .5))
  
p.insrat
```

```{r}
#NUM_CREDIT
p.numcre <- GermanCredit %>% 
  ggplot(aes(x = NUM_CREDITS, fill=as.factor(RESPONSE)))+
  geom_bar(position = "dodge") +
  labs(title = "Credit grade related to the number of credits",
       x = "Number of credits",
       y = "Number") +
  theme(legend.position="none") +
  scale_fill_manual(values = alpha(c("red3", "springgreen4"), .5))
  
p.numcre
```

```{r}
#NUM_DEPENDENT
p.numdep <- GermanCredit %>% 
  ggplot(aes(x = as.factor(NUM_DEPENDENTS), fill=as.factor(RESPONSE)))+
  geom_bar(position = "dodge") +
  labs(title = "Credit grade related to the number of dependent",
       x = "Number of people for whom liable to provide maintenance",
       y = "Number") +
  theme(legend.position="none") +
  scale_fill_manual(values = alpha(c("red3", "springgreen4"), .5))
  
p.numdep
```

```{r}
# Now let's have a look at the binary variables
# NEW_CAR
p_newcar <- GermanCredit %>% 
  ggplot(aes(x = as.factor(NEW_CAR), fill = as.factor(RESPONSE))) +
  geom_bar(position = "dodge") +
  labs(title = "Credit grade if for a new car",
       x = "",
       y = "Number") +
  theme(legend.position="none") +
  scale_x_discrete(label=c("0"="No", "1"="Yes")) +
  scale_fill_manual(values = alpha(c("red3", "springgreen4"), .5))

p_newcar
```

```{r}
# USED CAR
p_usecar <- GermanCredit %>% 
  ggplot(aes(x = as.factor(USED_CAR), fill = as.factor(RESPONSE))) +
  geom_bar(position = "dodge") +
  labs(title = "Credit grade if for a used car",
       x = "",
       y = "Number") +
  theme(legend.position="none") +
  scale_x_discrete(label=c("0"="No", "1"="Yes")) +
  scale_fill_manual(values = alpha(c("red3", "springgreen4"), .5))

p_usecar
```

```{r}
# FURNITURE
p_fur <- GermanCredit %>% 
  ggplot(aes(x = as.factor(FURNITURE), fill = as.factor(RESPONSE))) +
  geom_bar(position = "dodge") +
  labs(title = "Credit grade if for a furniture",
       x = "",
       y = "Number") +
  theme(legend.position="none") +
  scale_x_discrete(label=c("0"="No", "1"="Yes")) +
  scale_fill_manual(values = alpha(c("red3", "springgreen4"), .5))

p_fur
```

```{r}
# RADIO/TV
p_radtv <- GermanCredit %>% 
  ggplot(aes(x = as.factor(`RADIO/TV`), fill = as.factor(RESPONSE))) +
  geom_bar(position = "dodge") +
  labs(title = "Credit grade if for a radio/tv",
       x = "",
       y = "Number") +
  theme(legend.position="none") +
  scale_x_discrete(label=c("0"="No", "1"="Yes")) +
  scale_fill_manual(values = alpha(c("red3", "springgreen4"), .5))

p_radtv
```

```{r}
# EDUCATION
p_edu <- GermanCredit %>% 
  ggplot(aes(x = as.factor(EDUCATION), fill = as.factor(RESPONSE))) +
  geom_bar(position = "dodge") +
  labs(title = "Credit grade if for education",
       x = "",
       y = "Number") +
  theme(legend.position="none") +
  scale_x_discrete(label=c("0"="No", "1"="Yes")) +
  scale_fill_manual(values = alpha(c("red3", "springgreen4"), .5))

p_edu

# comment: pourquoi dans celui-ci il a -1 alors que le code est exactement identique? ligne 37 de la colonne EDUCATION du data GermanCredit il y a un -1. Pas normal. 
```

There is a -1, which seems to be wrong.

```{r}
# RETRAINING
p_ret <- GermanCredit %>% 
  ggplot(aes(x = as.factor(RETRAINING), fill = as.factor(RESPONSE))) +
  geom_bar(position = "dodge") +
  labs(title = "Credit grade if for retraining",
       x = "",
       y = "Number") +
  theme(legend.position="none") +
  scale_x_discrete(label=c("0"="No", "1"="Yes")) +
  scale_fill_manual(values = alpha(c("red3", "springgreen4"), .5))

p_ret
```

```{r}
# MALE_DIV
p_maldiv <- GermanCredit %>% 
  ggplot(aes(x = as.factor(MALE_DIV), fill = as.factor(RESPONSE))) +
  geom_bar(position = "dodge") +
  labs(title = "Credit grade if male and divorced",
       x = "",
       y = "Number") +
  theme(legend.position="none") +
  scale_x_discrete(label=c("0"="No", "1"="Yes")) +
  scale_fill_manual(values = alpha(c("red3", "springgreen4"), .5))

p_maldiv
```

```{r}
#MALE_SINGLE
p_malsin <- GermanCredit %>% 
  ggplot(aes(x = as.factor(MALE_SINGLE), fill = as.factor(RESPONSE))) +
  geom_bar(position = "dodge") +
  labs(title = "Credit grade if male and single",
       x = "",
       y = "Number") +
  theme(legend.position="none") +
  scale_x_discrete(label=c("0"="No", "1"="Yes")) +
  scale_fill_manual(values = alpha(c("red3", "springgreen4"), .5))

p_malsin
```

```{r}
# MALE_MAR_or_WID
p_malmarwid <- GermanCredit %>% 
  ggplot(aes(x = as.factor(MALE_MAR_or_WID), fill = as.factor(RESPONSE))) +
  geom_bar(position = "dodge") +
  labs(title = "Credit grade if male married or widowed",
       x = "",
       y = "Number") +
  theme(legend.position="none") +
  scale_x_discrete(label=c("0"="No", "1"="Yes")) +
  scale_fill_manual(values = alpha(c("red3", "springgreen4"), .5))

p_malmarwid
```

```{r}
#CO APLLICANT
p_coapp <- GermanCredit %>% 
  ggplot(aes(x = as.factor(`CO-APPLICANT`), fill = as.factor(RESPONSE))) +
  geom_bar(position = "dodge") +
  labs(title = "Credit grade if co-applicant",
       x = "",
       y = "Number") +
  theme(legend.position="none") +
  scale_x_discrete(label=c("0"="No", "1"="Yes")) +
  scale_fill_manual(values = alpha(c("red3", "springgreen4"), .5))

p_coapp
```
This one is also strange, meaning that if there is a co-applicant, it is more rejected? Must be the opposite

```{r}
#GUARANTOR
p_gua <- GermanCredit %>% 
  ggplot(aes(x = as.factor(GUARANTOR), fill = as.factor(RESPONSE))) +
  geom_bar(position = "dodge") +
  labs(title = "Credit grade if guarantor",
       x = "",
       y = "Number") +
  theme(legend.position="none") +
  scale_x_discrete(label=c("0"="No", "1"="Yes")) +
  scale_fill_manual(values = alpha(c("red3", "springgreen4"), .5))

p_gua
```

Again, what the 2?

```{r}
#REAL ESTATE
p_reaest <- GermanCredit %>% 
  ggplot(aes(x = as.factor(REAL_ESTATE), fill = as.factor(RESPONSE))) +
  geom_bar(position = "dodge") +
  labs(title = "Credit grade if own real estate",
       x = "",
       y = "Number") +
  theme(legend.position="none") +
  scale_x_discrete(label=c("0"="No", "1"="Yes")) +
  scale_fill_manual(values = alpha(c("red3", "springgreen4"), .5))

p_reaest
```

```{r}
#PROP_UNKN_NONE
p_prop <- GermanCredit %>% 
  ggplot(aes(x = as.factor(PROP_UNKN_NONE), fill = as.factor(RESPONSE))) +
  geom_bar(position = "dodge") +
  labs(title = "Credit grade if own no property or unknown",
       x = "",
       y = "Number") +
  theme(legend.position="none") +
  scale_x_discrete(label=c("0"="No", "1"="Yes")) +
  scale_fill_manual(values = alpha(c("red3", "springgreen4"), .5))

p_prop
```

What's the difference with real estate?

```{r}
#OTHER INSTALL
p_otherinstall <- GermanCredit %>% 
  ggplot(aes(x = as.factor(OTHER_INSTALL), fill = as.factor(RESPONSE))) +
  geom_bar(position = "dodge") +
  labs(title = "Credit grade if other installment plan",
       x = "",
       y = "Number") +
  theme(legend.position="none") +
  scale_x_discrete(label=c("0"="No", "1"="Yes")) +
  scale_fill_manual(values = alpha(c("red3", "springgreen4"), .5))

p_otherinstall
```

```{r}
# APPLICANT RENTS
p_apprent <- GermanCredit %>% 
  ggplot(aes(x = as.factor(RENT), fill = as.factor(RESPONSE))) +
  geom_bar(position = "dodge") +
  labs(title = "Credit grade if rent",
       x = "",
       y = "Number") +
  theme(legend.position="none") +
  scale_x_discrete(label=c("0"="No", "1"="Yes")) +
  scale_fill_manual(values = alpha(c("red3", "springgreen4"), .5))

p_apprent
```
Not sure of the meaning of this one?

```{r}
#OWN_RES
p_ownres <- GermanCredit %>% 
  ggplot(aes(x = as.factor(OWN_RES), fill = as.factor(RESPONSE))) +
  geom_bar(position = "dodge") +
  labs(title = "Credit grade if owns residence",
       x = "",
       y = "Number") +
  theme(legend.position="none") +
  scale_x_discrete(label=c("0"="No", "1"="Yes")) +
  scale_fill_manual(values = alpha(c("red3", "springgreen4"), .5))

p_ownres
```

Again what's the difference between this one and the two other ones: real estate and prop_unkn_none?
Seems to be redundant

```{r}
#TELEPHONE
p_tel <- GermanCredit %>% 
  ggplot(aes(x = as.factor(TELEPHONE), fill = as.factor(RESPONSE))) +
  geom_bar(position = "dodge") +
  labs(title = "Credit grade if telephone on his name",
       x = "",
       y = "Number") +
  theme(legend.position="none") +
  scale_x_discrete(label=c("0"="No", "1"="Yes")) +
  scale_fill_manual(values = alpha(c("red3", "springgreen4"), .5))

p_tel
```

Obviously, not of interest

```{r}
#FOREIGN
p_for <- GermanCredit %>% 
  ggplot(aes(x = as.factor(FOREIGN), fill = as.factor(RESPONSE))) +
  geom_bar(position = "dodge") +
  labs(title = "Credit grade if foreign workers",
       x = "",
       y = "Number") +
  theme(legend.position="none") +
  scale_x_discrete(label=c("0"="No", "1"="Yes")) +
  scale_fill_manual(values = alpha(c("red3", "springgreen4"), .5))

p_for
```

```{r, include=FALSE}
# let's check if old people have basically more credit than young people
mean_yes<-mean(YES_GC$AGE)
mean_yes

mean_no<-mean(NO_GC$AGE)
mean_no

# age does not seem to be a key criterion 
```


```{r}
# correlation matrix

#head(YES_GC)
#corgc <- cor(GermanCredit)
#corgc

#creation of a new dataset
cordata_fin <- GermanCredit[, c("CHK_ACCT", "HISTORY", "AMOUNT", "SAV_ACCT", "NUM_CREDITS", "RESPONSE") ] 
ggpairs(cordata_fin, title="Correlogram on financial data")

cordata_own <- GermanCredit[, c("NEW_CAR", "USED_CAR", "FURNITURE", "RADIO/TV", "RESPONSE") ]
ggpairs(cordata_own, title="Correlogram on owned products data")

cordata_pro <- GermanCredit[, c("JOB", "EDUCATION", "RETRAINING", "EMPLOYMENT", "RESPONSE") ] 
ggpairs(cordata_pro, title="Correlogram on professional data")

cordata_immo <- GermanCredit[, c("INSTALL_RATE", "REAL_ESTATE", "PRESENT_RESIDENT", "PROP_UNKN_NONE", "RENT", "OWN_RES", "RESPONSE") ]
ggpairs(cordata_immo, title="Correlogram on real estate data")

cordata_demo <- GermanCredit[, c("MALE_DIV", "MALE_SINGLE", "MALE_MAR_or_WID", "AGE", "FOREIGN", "RESPONSE") ] 
ggpairs(cordata_demo, title="Correlogram on demographic data")

#cor<-ggpairs(GermanCredit, title="correlogram with ggpairs()") 
```

```{r}
# create an average profile of yes person

# remove OBS column
Yes_profil<- YES_GC %>% 
  select("CHK_ACCT", "DURATION", "HISTORY", "NEW_CAR", "USED_CAR", "FURNITURE", "RADIO/TV", "EDUCATION", "RETRAINING", "AMOUNT", "SAV_ACCT", "EMPLOYMENT", "INSTALL_RATE", "MALE_DIV", "MALE_SINGLE", "MALE_MAR_or_WID", "CO-APPLICANT", "GUARANTOR", "PRESENT_RESIDENT", "REAL_ESTATE", "PROP_UNKN_NONE", "AGE", "OTHER_INSTALL", "RENT", "OWN_RES", "NUM_CREDITS", "JOB", "NUM_DEPENDENTS", "TELEPHONE", "FOREIGN")

#Yes_profil <- data.frame(Yes_profil)
#Yes_profil <- apply(as.matrix.noquote(Yes_profil),2,as.numeric)

# take the mean of each column
Yes_profil <- summarize_all(Yes_profil, mean) # not yet find a way to use median instead of mean

# show matrix through lolipop plot 
Yes_profil <- data.frame(
  x=c('CHK_ACCT', 'DURATION', 'HISTORY', 'NEW_CAR', 'USED_CAR', 'FURNITURE', 'RADIO.TV', 'EDUCATION', 'RETRAINING', 'AMOUNT', 'SAV_ACCT', 'EMPLOYMENT', 'INSTALL_RATE', 'MALE_DIV', 'MALE_SINGLE', 'MALE_MAR_or_WID', 'CO.APPLICANT', 'GUARANTOR', 'PRESENT_RESIDENT', 'REAL_ESTATE', 'PROP_UNKN_NONE', 'AGE', 'OTHER_INSTALL', 'RENT', 'OWN_RES', 'NUM_CREDITS', 'JOB', 'NUM_DEPENDENTS', 'TELEPHONE', 'FOREIGN'),
  y=abs(rnorm(30))
)
```

```{r}
graph_yes_profil <- ggplot(Yes_profil, aes(x=x, y=y)) +
  geom_segment( aes(x=x, xend=x, y=0, yend=y), color="skyblue") +
  geom_point( color="blue", size=4, alpha=0.6) +
  labs(
  title = "Mean of a YES profils",
  y = "Variables name", x = "Value"
)+
  theme_light() +
  coord_flip() +
  theme(
    panel.grid.major.y = element_blank(),
    panel.border = element_blank(),
    axis.ticks.y = element_blank() 
)

graph_yes_profil

#barplot(prop.table(Yes_profil) * 100, horiz=TRUE, main = "Relative frequency (%)", col = rainbow(3))
```

The following plot shows a selection of the most important variables of our dataframe.
The two main disadvantages of these methods are: The increasing overfitting risk when the number of observations is insufficient. The significant computation time when the number of variables is large.
```{r}
library(mlbench)
library(caret)

# transform table in matrix
GermanCredit <- data.frame(GermanCredit)
GermanCredit <- apply(as.matrix.noquote(GermanCredit),2,as.numeric)

# select important variables
control <- trainControl(method="repeatedcv", number=10, repeats=2)

# train the model
model <- train(RESPONSE~., data=GermanCredit, method="rpart", preProcess="scale", trControl=control)

# estimate variable importance
importance <- varImp(model, scale=FALSE)

# summarize importance
print(importance)

# plot importance
plot(importance)

# comment: we should find a way to print only positive results or to print only 10 firsts variables. 
```
